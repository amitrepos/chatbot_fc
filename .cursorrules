# FlexCube AI Assistant - Cursor Rules

## Project Context
You are helping build a RAG-based AI assistant for FlexCube banking software support.
The application runs on a Hetzner cloud server (16 vCPU, 32GB RAM, Rocky Linux, no GPU).
Everything must run locally - no external API calls to OpenAI, Anthropic, etc.

## Tech Stack (Do Not Change Without Discussion)
- LLM Runtime: Ollama
- Text Model: Mistral 7B Q4
- Vision Model: LLaVA 7B Q4
- Embeddings: BGE-large-en-v1.5
- Vector Database: Qdrant
- RAG Framework: LlamaIndex
- API Layer: FastAPI
- User Interface: Open WebUI (Phase 1), Custom Gradio (if needed)
- Reverse Proxy: Nginx
- Containerization: Docker + Docker Compose
- SSL: Let's Encrypt

## Server Details
- IP: 65.109.226.36
- OS: Rocky Linux
- RAM: 32GB
- vCPU: 16
- Disk: 360GB
- No GPU - CPU inference only

## Implementation Phases
Phase 1: Infrastructure (Docker, Ollama, Qdrant)
Phase 2: RAG Pipeline (LlamaIndex, embeddings, retrieval)
Phase 3: API Layer (FastAPI endpoints)
Phase 4: User Interface (Open WebUI integration)
Phase 5: Vision Support (LLaVA for screenshots)
Phase 6: Production Hardening (Nginx, SSL, monitoring)

## Coding Guidelines
- Use Python 3.11+
- Use async/await for API endpoints
- Add comprehensive error handling
- Include logging for debugging
- Write clear comments explaining FlexCube-specific logic
- Create modular, testable components
- Use environment variables for configuration
- Never hardcode secrets or API keys

## Testing Requirements (MANDATORY)
- **Unit Tests:** Write unit tests for EVERY function, class, or module you create or modify
  - Test all public methods and functions
  - Test edge cases and error conditions
  - Test both success and failure paths
  - Use pytest framework
  - Place tests in `src/tests/` directory mirroring source structure
- **Integration Tests:** Write integration tests for:
  - API endpoints (test full request/response cycle)
  - Database operations (test CRUD operations with test database)
  - RAG pipeline components (test end-to-end flows)
  - Authentication and authorization flows
- **Test Execution:** After completing any changes:
  1. Run unit tests: `python -m pytest src/tests/ -v`
  2. Run integration tests: `python -m pytest src/tests/integration/ -v`
  3. Run all tests: `python -m pytest src/tests/ -v --cov=src --cov-report=term`
  4. **MANDATORY:** Ensure all tests pass before considering work complete
  5. If tests fail, fix the issues before proceeding
- **Test Coverage:** Aim for >80% code coverage on new/modified code
- **Regression Prevention:** Tests must verify that existing functionality is not broken
- **Test Organization:**
  - Unit tests: `src/tests/unit/` or `src/tests/test_<module_name>.py`
  - Integration tests: `src/tests/integration/`
  - Fixtures: `src/tests/conftest.py`
- **Test Naming:** Use descriptive names: `test_<function_name>_<scenario>`
  - Example: `test_query_engine_returns_sources_when_available`
  - Example: `test_auth_requires_valid_jwt_token`

## When Suggesting Solutions
- Prefer simple solutions over complex ones
- Consider 32GB RAM constraint when suggesting models or batch sizes
- Remember there is no GPU - all inference is CPU-based
- Test commands should work on Rocky Linux (RHEL-based)
- Use Docker for all services for clean deployment

## File Organization
- Docker configs go in /docker
- Application code goes in /src
- FlexCube documents go in /data/documents
- Documentation goes in /docs

## Current Phase
Phase 7: User Authentication & RBAC (Planning Complete - Ready for Implementation)
- See `docs/PHASE_7_USER_AUTH_PLAN.md` for complete plan
- See `docs/IMPLEMENTATION_STEPS.md` for step-by-step checklist
